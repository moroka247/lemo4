{% extends "base.html" %}
{% load custom_filters %}

{% block title %}
{{ investment.company }} - Dashboard
{% endblock title %}

{% block content %}

<div class="investment-dashboard">

    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'investments' %}">Investments</a></li>
            <li class="breadcrumb-item active">{{ investment.company }}</li>
        </ol>
    </nav>

    <!-- Header Section -->
    <div class="dashboard-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">{{ investment.company }}</h2>
                <p class="text-muted mb-0">
                    <strong>{{ investment.fund }} • {{ investment.instrument }} • {{ investment.currency.code }}</strong>
                </p>
            </div>
            <div class="investment-status-badge">
                <span class="badge bg-success">Active</span>
                <span class="badge bg-info ms-1">{{ investment.currency.symbol }}</span>
            </div>
        </div>
        <hr class="mt-3">
    </div>

    <!-- Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-start-lg border-start-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-1">Committed Amount</h6>
                            <h4 class="mb-0">{{ investment.currency.symbol }}{{ investment.committed_amount|floatformat:2 }}</h4>
                        </div>
                        <div class="metric-icon bg-primary">
                            <i class="fas fa-file-contract"></i>
                        </div>
                    </div>
                    <div class="metric-progress mt-3">
                        <div class="progress">
                            <div class="progress-bar bg-primary" role="progressbar" 
                                 style="width: {% widthratio investment.invested_amount investment.committed_amount 100 %}%" 
                                 aria-valuenow="{% widthratio investment.invested_amount investment.committed_amount 100 %}" 
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small class="text-muted">{% widthratio investment.invested_amount investment.committed_amount 100 %}% drawn</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-start-lg border-start-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-1">Invested Amount</h6>
                            <h4 class="mb-0">{{ investment.currency.symbol }}{{ investment.invested_amount|floatformat:2 }}</h4>
                        </div>
                        <div class="metric-icon bg-success">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                    </div>
                    <div class="metric-delta mt-3">
                        {% if investment.invested_amount > 0 %}
                            <span class="badge bg-success">{{ investment.invested_amount|div:investment.committed_amount|floatformat:2 }}x</span>
                        {% else %}
                            <span class="badge bg-secondary">Not yet invested</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-start-lg border-start-info">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-1">Current Valuation</h6>
                            <h4 class="mb-0">{{ investment.currency.symbol }}{{ investment.valuation|default:investment.invested_amount|floatformat:2 }}</h4>
                        </div>
                        <div class="metric-icon bg-info">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="metric-delta mt-3">
                        {% if investment.valuation and investment.invested_amount > 0 %}
                            {% with multiple=investment.valuation|div:investment.invested_amount %}
                                <span class="badge bg-{% if multiple > 1.5 %}success{% elif multiple > 1 %}warning{% else %}danger{% endif %}">
                                    {{ multiple|floatformat:2 }}x MOIC
                                </span>
                            {% endwith %}
                        {% else %}
                            <span class="badge bg-secondary">Valuation: N/A</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-start-lg border-start-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-1">Realized Gains</h6>
                            <h4 class="mb-0">{{ investment.currency.symbol }}{{ investment.realized_gains|default:0|floatformat:2 }}</h4>
                        </div>
                        <div class="metric-icon bg-warning">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                    <div class="metric-delta mt-3">
                        {% if investment.realized_gains and investment.invested_amount > 0 %}
                            <span class="badge bg-info">{{ investment.realized_gains|div:investment.invested_amount|floatformat:2 }}x Return</span>
                        {% else %}
                            <span class="badge bg-secondary">No gains yet</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-xl-8 col-lg-7">
            <div class="card card-chart">
                <div class="card-header">
                    <h5 class="card-title">Investment Performance</h5>
                    <div class="card-tools">
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary">Monthly</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary active">Quarterly</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary">Yearly</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-xl-4 col-lg-5">
            <div class="card card-chart">
                <div class="card-header">
                    <h5 class="card-title">Capital Allocation</h5>
                </div>
                <div class="card-body">
                    <canvas id="capitalAllocationChart" height="300"></canvas>
                </div>
                <div class="card-footer bg-transparent">
                    <a href="#transactions" class="btn btn-sm btn-outline-primary w-100">View Transaction History</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Investment Details & Timeline Row -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Investment Details</h5>
                    <div class="card-tools">
                        <a href="{% url 'edit_investment' pk=investment.id %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-edit me-1"></i>Edit
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="40%">Company</th>
                                    <td>{{ investment.company }}</td>
                                </tr>
                                <tr>
                                    <th>Fund</th>
                                    <td>{{ investment.fund }}</td>
                                </tr>
                                <tr>
                                    <th>Instrument</th>
                                    <td>{{ investment.instrument }}</td>
                                </tr>
                                <tr>
                                    <th>Sector</th>
                                    <td>{{ investment.sector|default:"N/A" }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="40%">Deal Date</th>
                                    <td>{{ investment.deal_date|date:"M d, Y"|default:"N/A" }}</td>
                                </tr>
                                <tr>
                                    <th>Exit Date</th>
                                    <td>{{ investment.exit_date|date:"M d, Y"|default:"Active" }}</td>
                                </tr>
                                <tr>
                                    <th>Currency</th>
                                    <td>{{ investment.currency }} ({{ investment.currency.symbol }})</td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td>
                                        <span class="badge bg-{% if investment.status == 'Active' %}success{% elif investment.status == 'Exited' %}info{% else %}warning{% endif %}">
                                            {{ investment.status }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    {% if investment.notes %}
                    <div class="mt-3">
                        <h6>Notes</h6>
                        <p class="text-muted">{{ investment.notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Recent Activities</h5>
                    <div class="card-tools">
                        <a href="#transactions" class="btn btn-sm btn-link">View All</a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for transaction in recent_transactions|slice:":5" %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-{% if transaction.transaction_type == 'Distribution' %}success{% else %}primary{% endif %}"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between">
                                    <h6>{{ transaction.transaction_type }}</h6>
                                    <span class="text-muted">{{ transaction.date|date:"M d, Y" }}</span>
                                </div>
                                <p>
                                    {{ investment.currency.symbol }}{{ transaction.amount|floatformat:2 }}
                                    {% if transaction.description %}
                                        - {{ transaction.description }}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <p>No recent activities</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <a href="" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-plus me-1"></i>Add Transaction
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents & Files Section -->
    <div class="row mt-4" id="documents">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Investment Documents</h5>
                    <div class="card-tools">
                        <a href="" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus me-1"></i>Add Document
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if investment_documents %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Document Name</th>
                                    <th>Type</th>
                                    <th>Upload Date</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for document in investment_documents|slice:":5" %}
                                <tr>
                                    <td>{{ document.name }}</td>
                                    <td><span class="badge bg-info">{{ document.document_type }}</span></td>
                                    <td>{{ document.upload_date|date:"M d, Y" }}</td>
                                    <td class="text-end">
                                        <a href="{{ document.file.url }}" class="btn btn-sm btn-outline-info me-1" target="_blank">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'delete_investment_document' pk=document.id %}" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            {% if investment_documents|length > 5 %}
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-center">
                                        <a href="#all-documents" class="btn btn-sm btn-outline-primary">View All {{ investment_documents|length }} Documents</a>
                                    </td>
                                </tr>
                            </tfoot>
                            {% endif %}
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                        <p>No documents uploaded yet</p>
                        <a href="" class="btn btn-sm btn-primary mt-2">
                            <i class="fas fa-plus me-1"></i>Upload Document
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Investment Operations</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between flex-wrap">
                        <a class="btn btn-action-card" href="{% url 'edit_investment' pk=investment.id %}">
                            <div class="action-icon bg-primary">
                                <i class="fas fa-edit"></i>
                            </div>
                            <span>Edit Details</span>
                        </a>
            
                        <a class="btn btn-action-card" href="#">
                            <div class="action-icon bg-success">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <span>Add Transaction</span>
                        </a>
            
                        <a class="btn btn-action-card" href="#">
                            <div class="action-icon bg-info">
                                <i class="fas fa-file-upload"></i>
                            </div>
                            <span>Upload Document</span>
                        </a>
            
                        <a class="btn btn-action-card" href="#">
                            <div class="action-icon bg-warning">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <span>Update Valuation</span>
                        </a>
            
                        <a class="btn btn-action-card" href="{% url 'delete_investment' pk=investment.id %}" onclick="return confirm('Are you sure you want to delete this investment?')">
                            <div class="action-icon bg-danger">
                                <i class="fas fa-trash-alt"></i>
                            </div>
                            <span>Delete Investment</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Capital Allocation Chart
    var ctx1 = document.getElementById('capitalAllocationChart');
    if (ctx1) {
        var capitalAllocationChart = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Invested Capital', 'Remaining Commitment'],
                datasets: [{
                    data: [{{ investment.invested_amount }}, {{ investment.committed_amount|sub:investment.invested_amount }}],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(23, 162, 184, 0.8)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(23, 162, 184, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '{{ investment.currency.symbol }}' + context.raw.toLocaleString();
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // Performance Chart
    var ctx2 = document.getElementById('performanceChart');
    if (ctx2) {
        // Sample data - you would replace with your actual time series data
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var valuationData = [100, 120, 130, 145, 165, 190, 210, 230, 250, 270, 290, 310];
        
        var performanceChart = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Valuation',
                        data: valuationData,
                        borderColor: 'rgba(0, 123, 255, 1)',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: true,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Valuation ({{ investment.currency.symbol }})'
                        }
                    }
                }
            }
        });
    }

    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            if (targetId !== '#') {
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        });
    });
});
</script>

<style>
.investment-dashboard {
    padding: 20px 0;
}

.dashboard-header {
    background: linear-gradient(120deg, #f8f9fa 0%, #fff 100%);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

.metric-card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: transform 0.3s;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.border-start-lg {
    border-left-width: 4px !important;
}

.border-start-primary {
    border-left-color: #4e73df !important;
}

.border-start-success {
    border-left-color: #1cc88a !important;
}

.border-start-info {
    border-left-color: #36b9cc !important;
}

.border-start-warning {
    border-left-color: #f6c23e !important;
}

.metric-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.card-chart {
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.card-chart .card-header {
    background: transparent;
    border-bottom: 1px solid #eaecf4;
    padding: 20px 20px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-chart .card-body {
    padding: 20px;
}

.card-title {
    font-weight: 600;
    color: #5a5c69;
    margin-bottom: 0;
}

.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    padding-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -30px;
    top: 5px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    z-index: 2;
}

.timeline-content {
    padding-left: 15px;
}

.timeline-item:not(:last-child):before {
    content: '';
    position: absolute;
    left: -24px;
    top: 20px;
    height: calc(100% - 5px);
    border-left: 2px dashed #e3e6f0;
}

.table th {
    font-weight: 600;
    color: #5a5c69;
    border-top: none;
}

.progress {
    height: 8px;
    border-radius: 4px;
}

.btn-action-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 18%;
    min-width: 120px;
    padding: 15px 10px;
    margin: 0 5px 10px;
    border: 1px solid #e3e6f0;
    border-radius: 8px;
    text-align: center;
    transition: all 0.3s;
    text-decoration: none;
    color: #5a5c69;
}

.btn-action-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    text-decoration: none;
    color: #4e73df;
}

.action-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

@media (max-width: 768px) {
    .btn-action-card {
        width: 48%;
        margin-bottom: 15px;
    }
    
    .metric-icon {
        width: 40px;
        height: 40px;
    }
}
</style>

{% endblock content %}