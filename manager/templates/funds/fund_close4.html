{% extends "base.html" %}
{% load custom_filters %}

{% block title %}
Fund Close: {{ fund.name }}
{% endblock title %}

{% block content %}

<div class="container">
    <h4>Committed Capital to {{ fund.name }}</h4>

    <!-- Input Form Section -->
    <div class="row my-5">
        <div class="col-md-6"> <!-- Reduced width to half of the page -->
            <form id="input-form" method="post">
                {% csrf_token %}
                
                <div class="form-container">
                    <!-- Input Form Header -->
                    <div class="form-header">
                        <div class="form-header-item wide">Investor</div>
                        <div class="form-header-item narrow">Amount</div>
                        <div class="form-header-item narrow"></div>
                    </div>

                    <!-- Input Form Row -->
                    <div class="form-row">
                        <div class="form-item wide">
                            {{ formset.empty_form.investor }}
                        </div>
                        <div class="form-item narrow">
                            {{ formset.empty_form.amount }}
                        </div>
                        <div class="form-item narrow">
                            <button type="button" class="btn btn-sm btn-secondary" id="add-form">+</button>
                        </div>
                    </div>
                </div>
            </form>
            <p id="message" style="color: red; display: none;">The investor has already been added below. To edit the investor, it must first be removed from the summary below.</p>
        </div>
    </div>

    <!-- Summary Section -->
    <div class="row my-5">
        <div class="col-md-12">
            <h5>Summary</h5>
            <form id="summary-form" method="post">
                {% csrf_token %}
                <div class="form-container">
                    <!-- Summary Header Row -->
                    <div class="form-header">
                        <div class="form-header-item wide">Investor</div>
                        <div class="form-header-item narrow">Amount</div>
                        <div class="form-header-item narrow">Percentage</div>
                        <div class="form-header-item narrow">Actions</div>
                    </div>

                    <!-- Summary Rows -->
                    <div id="summary-rows">
                        <!-- Rows will be dynamically added here -->
                    </div>

                    <!-- Total Row -->
                    <div class="form-row total-row">
                        <div class="form-item wide">Total</div>
                        <div class="form-item narrow" id="total-amount">0.00</div>
                        <div class="form-item narrow"></div>
                        <div class="form-item narrow"></div>
                    </div>

                    <!-- Hidden Field for Summary Data -->
                    <input type="hidden" name="summary_data" id="summary_data">

                    <!-- Submit Button -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-sm btn-success" id="submit-summary">Submit</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .form-container {
        display: flex;
        flex-direction: column;
    }

    .form-header, .form-row {
        display: flex;
        flex-direction: row;
        margin-bottom: 5px;
    }

    .form-header-item, .form-item {
        padding: 5px;
        border: 1px solid #ddd;
        box-sizing: border-box;
    }

    .form-header-item {
        font-weight: bold;
        background-color: #417a59; /* Updated background color */
        color: white; /* Updated text color */
    }

    .form-header-item.wide, .form-item.wide {
        flex: 4; /* Make the first column wider */
    }

    .form-header-item.narrow, .form-item.narrow {
        flex: 1; /* Make the other columns narrower */
    }

    .form-actions {
        margin-top: 5px;
    }

    .form-actions button {
        margin-right: 5px;
    }

    .total-row {
        font-weight: bold;
        background-color: #f4f4f4;
    }

    .total-row .form-item {
        border: 1px solid #ddd;
    }

    .summary-row .form-item {
        border: 1px solid #ddd;
        padding: 8px;
    }

    .summary-row {
        display: flex;
        flex-direction: row;
        margin-bottom: 5px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addButton = document.getElementById('add-form');
        const summaryRows = document.getElementById('summary-rows');
        const totalAmountElement = document.getElementById('total-amount');
        const investorField = document.querySelector('#input-form select[name$="investor"]');
        const amountField = document.querySelector('#input-form input[name$="amount"]');
        const messageElement = document.getElementById('message');
        let totalAmount = 0;
        let existingInvestors = new Set();

        function calculateTotal() {
            totalAmount = 0;
            document.querySelectorAll('#summary-rows .form-item.narrow.amount').forEach(function (item) {
                const value = parseFloat(item.textContent) || 0;
                totalAmount += value;
            });
            totalAmountElement.textContent = totalAmount.toFixed(2);

            // Update percentages
            document.querySelectorAll('#summary-rows .summary-row').forEach(function (row) {
                const amountElement = row.querySelector('.form-item.narrow.amount');
                const amount = parseFloat(amountElement.textContent) || 0;
                const percentage = totalAmount > 0 ? ((amount / totalAmount) * 100).toFixed(2) + '%' : '0.00%';
                amountElement.nextElementSibling.textContent = percentage;
            });
        }

        function addToSummary(investor, amount) {
            if (existingInvestors.has(investor)) {
                messageElement.style.display = 'block';
                return;
            } else {
                messageElement.style.display = 'none';
            }

            const summaryRow = document.createElement('div');
            summaryRow.className = 'form-row summary-row';
            summaryRow.innerHTML = `
                <div class="form-item wide">${investor}</div>
                <div class="form-item narrow amount">${amount}</div>
                <div class="form-item narrow">0.00%</div>
                <div class="form-item narrow">
                    <button type="button" class="btn btn-sm btn-danger remove-row">-</button>
                </div>
            `;
            summaryRows.appendChild(summaryRow);
            existingInvestors.add(investor);
            calculateTotal();
        }


        function loadSavedData() {
        const path = window.location.pathname;
        const segments = path.split('/');
        const fundIdIndex = segments.indexOf('fund') + 1;
        const fundId = segments[fundIdIndex];

        fetch(`/summary-data/${fundId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok');
        })
        .then(data => {
            data.forEach(item => {
                addToSummary(item.investor, parseFloat(item.amount).toFixed(2));
            });
        })
        .catch(error => {
            console.error('Error fetching saved data:', error);
        });
    }
        loadSavedData();

    function deleteRow(investorName, rowElement) {
        const csrfToken = getCookie('csrftoken'); // Function to get CSRF token if necessary

        fetch(`/summary-data/1`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken, // Include CSRF token if enabled
            },
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Failed to delete the entry.');
        })
        .then(data => {
            console.log(data.message);
            rowElement.remove();
            calculateTotal(); // Update totals
        })
        .catch(error => {
            console.error('Error:', error);
            messageElement.textContent = 'Error deleting the entry.';
            messageElement.style.display = 'block';
        });
    }
        addButton.addEventListener('click', function (e) {
            const investor = investorField.options[investorField.selectedIndex].text;
            const amount = parseFloat(amountField.value).toFixed(2);

            if (!investor || isNaN(amount) || amount <= 0) {
                alert('Please select an investor and enter a valid amount.');
                return;
            }

            addToSummary(investor, amount);
            // Clear input fields
            investorField.value = '';
            amountField.value = '';
            e.preventDefault()
        });

        summaryRows.addEventListener('click', function (event) {
            if (event.target.classList.contains('remove-row')) {
                const row = event.target.closest('.summary-row');
                const investorName = row.querySelector('.form-item.wide').textContent;
                if (investorName) {
                    if (confirm('Are you sure you want to delete this entry?')) {
                            deleteRow(investorName, row);
                            row.remove();
                            existingInve
                            stors.delete(investorName);
                            calculateTotal();
                        }
                } else {
                    console.error('Row ID is missing.');
                }

            }
        });

        document.getElementById('summary-form').addEventListener('submit', function (e) {
            const data = Array.from(document.querySelectorAll('#summary-rows .summary-row')).map(row => {
                return {
                    investor: row.querySelector('.form-item.wide').textContent,
                    amount: row.querySelector('.form-item.narrow.amount').textContent,
                };
            });

            const path = window.location.pathname;
            const segments = path.split('/');
            const fundIdIndex = segments.indexOf('fund') + 1;
            const fundId = segments[fundIdIndex];
            console.log('Fund ID:', fundId);

            fetch(`/summary-data/${fundId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'), // Include CSRF token if CSRF protection is enabled
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                console.log('Success:', data);
            })
            .catch(error => {
                console.error('Error:', error);
            });

            console.log(JSON.stringify(data) , 'fffffffffffffffffffffffffffffff');
            // Set the hidden input field value to serialized summary data
            document.getElementById('summary_data').value = JSON.stringify(data);
            e.preventDefault();
        });
    });
    
    function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
</script>

{% endblock content %}
